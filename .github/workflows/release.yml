name: Release

on:
  release:
    types: [published]

jobs:
  update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Debug - Show environment
        run: |
          echo "::group::Environment Info"
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Release tag: ${{ github.event.release.tag_name }}"
          echo "Release name: ${{ github.event.release.name }}"
          echo "GITHUB_REF: ${{ github.ref }}"
          echo "::endgroup::"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          echo "::group::Configuring Git"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --list | grep -E "(user.name|user.email)"
          echo "::endgroup::"

      - name: Extract version from release
        id: version
        run: |
          echo "::group::Extracting version"
          # Utiliser le tag_name de l'événement release plutôt que GITHUB_REF
          TAG_NAME="${{ github.event.release.tag_name }}"
          if [ -z "$TAG_NAME" ]; then
            # Fallback sur GITHUB_REF si tag_name n'est pas disponible
            TAG_NAME=${GITHUB_REF#refs/tags/}
          fi
          VERSION=${TAG_NAME#v}
          echo "Tag name: $TAG_NAME"
          echo "Version: $VERSION"
          if [ -z "$VERSION" ]; then
            echo "ERROR: Could not extract version from tag" >&2
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"

      - name: Check current manifest version
        run: |
          echo "::group::Current manifest version"
          if [ -f "custom_components/custody_schedule/manifest.json" ]; then
            CURRENT_VERSION=$(python3 -c "import json; print(json.load(open('custom_components/custody_schedule/manifest.json'))['version'])")
            echo "Current version in manifest: $CURRENT_VERSION"
            echo "Target version: ${{ steps.version.outputs.version }}"
            if [ "$CURRENT_VERSION" = "${{ steps.version.outputs.version }}" ]; then
              echo "Version already matches, no update needed"
              echo "skip_update=true" >> "$GITHUB_ENV"
            else
              echo "Version mismatch, will update"
              echo "skip_update=false" >> "$GITHUB_ENV"
            fi
          else
            echo "ERROR: manifest.json not found!"
            exit 1
          fi
          echo "::endgroup::"

      - name: Update manifest version
        if: env.skip_update != 'true'
        run: |
          echo "::group::Updating manifest version"
          if [ ! -f "scripts/update_version.py" ]; then
            echo "ERROR: update_version.py script not found!"
            exit 1
          fi
          python3 scripts/update_version.py "${{ steps.version.outputs.version }}"
          echo "Manifest updated"
          cat custom_components/custody_schedule/manifest.json | grep version
          echo "::endgroup::"

      - name: Commit version bump
        if: env.skip_update != 'true'
        run: |
          echo "::group::Committing version bump"
          git add custom_components/custody_schedule/manifest.json
          if git diff --staged --quiet; then
            echo "No changes to commit (version already matches)"
          else
            echo "Committing changes..."
            git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
            echo "Pushing to main..."
            if git push origin HEAD:main; then
              echo "✓ Version bump pushed successfully"
            else
              echo "⚠ Push failed, but continuing (may already be up to date)"
            fi
          fi
          echo "::endgroup::"

      - name: Final status
        if: always()
        run: |
          echo "::group::Final Status"
          if [ "${{ job.status }}" = "success" ]; then
            echo "✓ Release workflow completed successfully"
          else
            echo "✗ Release workflow failed"
            exit 1
          fi
          echo "::endgroup::"
